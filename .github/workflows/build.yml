name: Build and Test

on:
  push:
    branches:
      - '**'  # Build on push to any branch
  pull_request:
    branches:
      - '**'  # Build on PR to any branch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Build plugin
        run: npm run build

      - name: Verify build
        run: |
          echo "Build verification:"
          ls -lh .scaffold/build/*.xpi

          echo ""
          echo "XPI contents (first 50 files):"
          unzip -l .scaffold/build/*.xpi | head -55

          echo ""
          echo "Critical files check:"
          unzip -l .scaffold/build/*.xpi | grep -E "(bootstrap.js|manifest.json|replicationChecker.js)"

          echo ""
          echo "XPI size:"
          du -h .scaffold/build/*.xpi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: zotero-replication-checker-build-${{ github.sha }}
          path: .scaffold/build/*.xpi
          retention-days: 30

      - name: Add build info comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const xpiPath = fs.readdirSync('.scaffold/build/').find(f => f.endsWith('.xpi'));
            const xpiSize = fs.statSync(`.scaffold/build/${xpiPath}`).size;
            const sizeMB = (xpiSize / 1024 / 1024).toFixed(2);

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… Build successful!\n\n**Artifact:** \`${xpiPath}\`\n**Size:** ${sizeMB} MB\n\nDownload from the artifacts section above.`
            });
