name: Create Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.3.0, v1.0.0, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.3.0)'
        required: true
        default: 'v0.3.0'

permissions:
  contents: write
  actions: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Get version from package.json
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "VERSION_NUM=${VERSION}" >> $GITHUB_OUTPUT
          echo "Package version: v${VERSION}"

      - name: Determine release version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ steps.package_version.outputs.VERSION }}"
          fi
          VERSION_NUM=$(echo "$VERSION" | sed 's/^v//')

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUM=$VERSION_NUM" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION (numeric: $VERSION_NUM)"

      - name: Build plugin
        run: npm run build

      - name: Verify build
        run: |
          echo "Build verification:"
          XPI_FILE=$(ls .scaffold/build/*.xpi)
          ls -lh "$XPI_FILE"

          echo ""
          echo "XPI contents (first 50 files):"
          unzip -l "$XPI_FILE" | head -55

      - name: Prepare XPI for release
        run: |
          # The scaffold creates the XPI with the correct name based on addonName
          # We use this name directly to match update.json
          XPI_SOURCE=$(ls .scaffold/build/*.xpi)
          XPI_BASENAME=$(basename "$XPI_SOURCE")

          cp "$XPI_SOURCE" "./$XPI_BASENAME"
          echo "XPI_NAME=$XPI_BASENAME" >> $GITHUB_ENV
          echo "XPI file: $XPI_BASENAME"

      - name: Create update.json
        run: |
          VERSION_NUM="${{ steps.version.outputs.VERSION_NUM }}"
          VERSION="${{ steps.version.outputs.VERSION }}"
          # Use the same XPI filename that scaffold generates
          XPI_NAME="${{ env.XPI_NAME }}"

          # Compute SHA-512 hash of the XPI file for update verification
          XPI_HASH=$(sha512sum "$XPI_NAME" | cut -d' ' -f1)
          echo "XPI SHA-512 hash: $XPI_HASH"

          cat > update.json << EOF
          {
            "addons": {
              "replication-checker@forrt.org": {
                "updates": [
                  {
                    "version": "$VERSION_NUM",
                    "update_link": "https://github.com/forrtproject/fred_zotero/releases/download/${VERSION}/${XPI_NAME}",
                    "update_hash": "sha512:${XPI_HASH}",
                    "applications": {
                      "zotero": {
                        "strict_min_version": "7.0",
                        "strict_max_version": "8.*"
                      }
                    }
                  }
                ]
              }
            }
          }
          EOF

          echo "Created update.json:"
          cat update.json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'alpha') }}
          generate_release_notes: true
          body: |
            ## Zotero Replication Checker ${{ steps.version.outputs.VERSION }}

            Privacy-first plugin to discover replications from the FORRT Literature Database (FLoRA).

            ---

            ## ðŸ“¥ **[â¬‡ï¸ CLICK HERE TO DOWNLOAD](https://github.com/forrtproject/fred_zotero/releases/download/${{ steps.version.outputs.VERSION }}/${{ env.XPI_NAME }})**

            **Direct Download:** [`${{ env.XPI_NAME }}`](https://github.com/forrtproject/fred_zotero/releases/download/${{ steps.version.outputs.VERSION }}/${{ env.XPI_NAME }})

            ---

            ### âœ¨ New in This Release

            Check the release notes below for all changes.

            ### ðŸ“¥ Installation

            1. **Click the download link above** or download `${{ env.XPI_NAME }}` from Assets below
            2. In Zotero: **Tools â†’ Add-ons** (or **Edit â†’ Settings â†’ Advanced â†’ Settings Editor**)
            3. Click gear icon âš™ï¸ â†’ **Install Add-on From File**
            4. Select the downloaded XPI file
            5. Restart Zotero

            ### ðŸŽ¯ Features

            - âœ… **3-Screen Interactive Onboarding** - Get started with a guided tour
            - âœ… **User Guide in Help Menu** - Access onboarding anytime from Help â†’ Replication Checker User Guide
            - âœ… **Auto-Tag Replication Studies** - Items added to library are tagged "Added by Replication Checker"
            - âœ… **Check Entire Library** - Scan all items via Tools menu
            - âœ… **Check Collections** - Right-click any collection to check for replications
            - âœ… **Check Individual Items** - Right-click items to check selected ones
            - âœ… **Automatic Tagging** - Original studies get "Has Replication" tag with outcome tags
            - âœ… **Detailed Notes** - Replication info added as child notes with DOI links
            - âœ… **Privacy-First Design** - Hash-based lookup protects your DOIs
            - âœ… **Auto-Cleanup** - Preferences cleared on uninstall

            ### âš™ï¸ Configuration

            **Settings:** Edit â†’ Settings â†’ Replication Checker
            - Auto-check frequency (disabled/daily/weekly/monthly)
            - Auto-check newly added items

            **Menu Locations:**
            - **Tools** â†’ Check Current Library for Replications
            - **Help** â†’ Replication Checker User Guide
            - **Right-click** items/collections â†’ Check for Replications

            ### ðŸ“‹ Requirements

            - Zotero 7.0 or later
            - Items must have DOIs to be checked
            - Internet connection for API queries

            ### ðŸ› Troubleshooting

            If you encounter issues:
            1. **Help** â†’ **Debug Output Logging** â†’ **View Output**
            2. Look for messages starting with `[ReplicationChecker]:`
            3. Report issues at: https://github.com/forrtproject/fred_zotero/issues

            ### ðŸ™ Credits

            - **FORRT Project** - For the comprehensive Replication Database
            - **FLoRA Team** - For maintaining the replication data
            - **Contributors** - Everyone who helped improve this plugin

            ---

            **ðŸ“¦ Download the XPI file below to install the plugin.**

            The plugin will automatically check for updates using `update.json`.
          files: |
            ${{ env.XPI_NAME }}
            update.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger GitHub Pages rebuild
        run: |
          echo "Triggering GitHub Pages workflow to update update.json..."
          gh workflow run pages.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
